# mesh

Mesh data types

[![python](https://img.shields.io/badge/python-3.11-blue.svg)](https://www.python.org/)
![os](https://img.shields.io/badge/os-ubuntu%20|%20macos%20|%20windows-blue.svg)
[![license](https://img.shields.io/badge/license-MIT-green.svg)](https://github.com/sandialabs/sibl#license) 
[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)

[![tests](https://github.com/autotwin/mesh/workflows/tests/badge.svg)](https://github.com/autotwin/mesh/actions) [![codecov](https://codecov.io/gh/autotwin/mesh/branch/main/graph/badge.svg?token=XY0UAVX3OD)](https://codecov.io/gh/autotwin/mesh)


## Config

See [config/README.md](config/README.md)

## Workflow

See [doc/README.md](doc/README.md)

## Schema

* `version 1.8` (see [updates](#updates) section)
* [template_version_1.8.yml](template_version_1.8.yml)
* [template_version_1.7.yml](template_version_1.7.yml)
* [template_version_1.6.yml](template_version_1.6.yml)

| `key` | type | description | new in version
| --- | --- | --- | ---:
| `autotwin_header` | dict | Header used for pedigree and tracking purposes | 1.6
| - `created`       | string | A manual (or script autogenerated) date and time step, e.g., `created: "2023-04-26-1533-MST"` | 1.6
| - `source`        | string | The person, machine, or script that generated the `.yml` input | 1.6
| `bounding_box` | dict | |  1.5
| - `auto`     | bool | `True` autogenerates the bounding box, and `xmin` through `zmax` parameters are ignored.</br>`False` uses `xmin` through `zmax` parameters the bounding box. | 1.5
| - `defeatured` | bool | `True` turns on defeaturing near the bounding box boundary. </br>*True eliminated "horns" and "projections" in past investigations.  Recommended as True for brain models.*</br>`False` turns off defeaturing near the bounding box boundary. | 1.5
| - `xmin` | float | The `x-coordinate` minimum of the bounding box. | 1.4
| - `ymin` | float | The `y-coordinate` minimum of the bounding box. | 1.4
| - `zmin` | float | The `z-coordinate` minimum of the bounding box. | 1.4
| - `xmax` | float | The `x-coordinate` maximum of the bounding box. | 1.4
| - `ymax` | float | The `y-coordinate` maximum of the bounding box. | 1.4
| - `zmax` | float | The `z-coordinate` maximum of the bounding box. | 1.4
| `cell_size` | float | The Sculpt cell size, in units of the `.stl` input file for the Sculpt baseline mesh size. | 1.4
| ~~`csv_path_file`~~ | string | **deprecated** in version 1.6, superceded by `qualities` | 1.6
| `cubit_path` | string | The full path to the Cubit executable, e.g., `"/Applications/Cubit-16.08/Cubit.app/Contents/MacOS"` | 1.4
| `inp_path_file` | string | The full path to the ABAQUS `.inp` mesh file, e.g., `"~/autotwin/mesh/tests/files/sphere.inp"`</br>A Genesis `.g` mesh file is automatically generated too, with the corresponding path and file name, e.g., `"~/autotwin/mesh/tests/files/sphere.g"` | 1.4
| `journaling` | bool | `True` turns on Cubit journaling of the process.</br>`False` turns the journaling off. | 1.4
| `mesh_adaptivity` | dict | *optional* | 1.7 
| - `adapt_levels`  | int  | Default is `2`. | 1.7
| - `adapt_type`    | int  |  Facet to Surface Distance (1)</br>Surface to Facet Distance (2)</br>Surface to Surface (3)</br>Volume Fraction Average (4)</br>Coarsen (5)</br>Volume Fraction Difference (6)</br>Resample (7)</br>Material (8) | 1.7
| `mesh_improvement` | dict | *optional* | 1.7
| - `pillow_curves`  | bool | `True` requires `pillow_curve_layers` and `pillow_curve_thresh`. | 1.7
| - `pillow_curve_layers` | int   | Default is `3`. | 1.7
| - `pillow_curve_thresh` | float | Default is `0.3`.  Curve pillow SJ threshold. | 1.7
| - `pillow_surfaces` | bool | `True` turns on surface pillowing. | 1.7
| `n_procs` | int | The number of parallel processors uses for Sculpt | 1.4
| `qualities` | list(str) | Mesh quality metrics of the `.inp` mesh specified by the `inp_path_file` key, one or more of the following: `["aspect ratio", "scaled jacobian", "skew"]` | 1.6
| `stair_step` | bool | *optional*</br>Default is `False`.</br>`True` creates a voxel-style (aka "sugar cube") mesh (equivalent to an Eulerian mesh but in Lagrangian form).</br>`False` uses curvature of a body's surface. | 1.8
| `stl_path_files` | list(str) | A list of one or more strings.  Each string contains the path and file to an input `.stl` file given to Sculpt. | 1.4
| `stl_scale_factor` | int | Scales the input `stl` geometry by the `stl_scale_factor`.  Allows geometries to be made smaller/larger prior to meshing.  *Optional.*  Defaults to `1.0` if not specified. | 1.7
| `version` | float | The version of the `.yml` input file | 1.4
| `working_dir` | string | The path for the Cubit/Sculpt working directory, e.g., temporary files, journal files | 1.4

## Updates

### 2023-08-18

The current `.yml` input version now `1.8`.  All input files must be a miniumum of version `1.7`.
The module `sculpt_stl_to_inp.py` now only supports version `1.7` or higher.  Lower version input
files must be updated prior to use with the `sculpt_stl_to_inp.py` module.

Implemented `stair_step` for all-hex voxel style mesh output.

### 2023-06-27

`.yml` input version from `1.5` to `1.6`, updated keys: `mesh_adaptivity` and `mesh_improvement`.


### 2023-04-26

`.yml` input version from `1.5` to `1.6`, updated keys:

 `qualities: (string,)` is a tuple of strings with zero or more of the following: `("aspect ratio", "scaled jacobian", "skew")`
  * Example: All of the quality metrics:
    * `qualities: ("aspect ratio", "scaled jacobian", "skew")`
  * Example: One quality metric, skew:
    * `qualities: ("skew")`
  * Example: Zero quality metrics:
    * `qualities: ()`

**deprecated:** `csv_path_file` now ~~`csv_path_file`~~ (no longer used)
 * Previously use for `.csv` output of a hard-coded quality metric, e.g., *minimum scaled Jacobian*
   * Example:  
     * `csv_path_file: "~/Downloads/scratch/Utah_SCI_brain/cell_100_msj.csv"`
 * Now naming for quality metric `.csv` outputs is autogenerated, based on the tuple of quality metric string(s) used as input to the [`cubit_inp_to_quality_csv.py`](src/atmesh/cubit_inp_to_quality_csv.py) module.
   * Example:
     * `.inp` file: `"~/autotwin/mesh/tests/files/sphere_cell_0010.inp"` and `("scaled jacobian")` as inputs produce
     * `.csv` file: `"/Users/chovey/autotwin/mesh/tests/files/sphere_cell_0010_scaled_jacobian.csv"`

### 2023-04-12

`.yml` input version from `1.4` to `1.5`, updated keys:

* `bounding_box: (auto, defeatured, xmin, xmax, ymin, ymax, zmin, zmax)`
   * `auto (boolean)`
      * `True` (default) Sculpt chooses the bounding box.
      * `False` The user input `xmin, xmax, ymin, ymax, zmin, zmax` defined the bounding box.
   * `defeatured (boolean)`
      * maps to Sculpt `defeature_bbox` and `defeature 1` (on)
      * `True` turns on Sculpt defeature, and defeatures at boundary of the bounding box.
      * `False` (default) turns off Sculpt defeature, and no defature at the boundary of the bounding box occurs.

where the bounding box is defined with two points, a minimum and a maximum, as follows:

$$(x, y, z)_{\min} = \mathtt{ (xmin, ymin, zmin)}$$

and

$$(x, y, z)_{\max} = \mathtt{ (xmax, ymax, zmax)}$$


### 2023-03-03

* Python from 3.7.9 to 3.11.2.
* Virtual environment naming from `atmeshenv` to `.venv`.
* `sculpt_stl_to_inp.py` input `.yml` file version from `1.3` to `1.4`.

### Equations Example

From https://github.blog/2022-05-19-math-support-in-markdown/

When $a \ne 0$, there are two solutions to $(ax^2 + bx + c = 0)$ and they are

$$ x = {-b \pm \sqrt{b^2-4ac} \over 2a} $$

**The Cauchy-Schwarz Inequality**

```math
\left( \sum_{k=1}^n a_k b_k \right)^2 \leq \left( \sum_{k=1}^n a_k^2 \right) \left( \sum_{k=1}^n b_k^2 \right)
```

## Future Reading

* https://github.com/pyenv/pyenv


## SPN

The `xyz.i` file:

```bash
BEGIN SCULPT

  nelx = 10
  nely = 20
  nelz = 30
  stair = 1
  input_spn = xyz.spn
  exodus_file = xyz
  spn_xyz_order = 0

END SCULPT
```

The `xyz.spn` file:

```bash
4
4
4
4
4
4
4
4
4
4
4
4
4
4
... # to line 6000, composed of 1, 2, 3, 4, where 4 is the surrounding material
# and the number of elements is 10 x 20 x 30 = 6000 element
```

And running sculpt to create the mesh:

```bash
(.venv)  chovey@s1088757/Users/chovey/Downloads/spn> /Applications/Cubit-16.14/Cubit.app/Contents/MacOS/sculpt -i xyz.i
SCULPT Running on host name: s1088757
At time: Mon May 20 18:01:53 2024

Initializing MPI on 1 Processors: mpiexec = /Applications/Cubit-16.14/Cubit.app/Contents/MacOS/mpiexec


/Applications/Cubit-16.14/Cubit.app/Contents/MacOS/mpiexec --mca oob_tcp_if_include lo0 --mca btl ^tcp -n 1 /Applications/Cubit-16.14/Cubit.app/Contents/MacOS/psculpt -i xyz.i

Reading input file xyz.i...
Finished reading input file...

                 SANDIA NATIONAL LABORATORIES

     SSSSS     CCCCC    UU   UU   LL        PPPPPP    TTTTTT
    SS   SS   CC   CC   UU   UU   LL        PP   PP     TT
    SS        CC        UU   UU   LL        PP   PP     TT
     SSSSS    CC        UU   UU   LL        PPPPPP      TT
         SS   CC        UU   UU   LL        PP          TT
    SS   SS   CC   CC   UU   UU   LL        PP          TT
     SSSSS     CCCCC     UUUUU    LLLLLLL   PP          TT

                     PARALLEL HEX MESHING
                            FROM
                     VOLUME FRACTION DATA

              SCULPT Version 16.14.7 Build bf6ed33e6b
              Copyright 2015 Sandia Corporation
      Revised Fri Dec 15 08:36:16 2023 -0700
      User Support and Bug Reports: cubit-help@sandia.gov

     SCULPT includes CAMAL by Sandia National Laboratories
  SCULPT includes CTH Diatoms by Sandia National Laboratories
  SCULPT is a companion application to the CUBIT Geometry and
       Meshing Toolkit by Sandia National Laboratories

Input: /Applications/Cubit-16.14/Cubit.app/Contents/MacOS/psculpt
  --input_file      -i    xyz.i
  --input_spn       -isp  xyz.spn
  --spn_xyz_order   -spo  0
  --exodus_file     -e    xyz
  --nelx            -x    10
  --nely            -y    20
  --nelz            -z    30
  --stair           -str  ON (1)
  --smooth          -S    3
  --csmooth         -CS   2
  --laplacian_iters -LI   10

Decomposing Cartesian grid for parallel...
  Rank 0 Number of cells/segment in directions X 	 10
  Rank 0 Number of cells/segment in directions Y 	 20
  Rank 0 Number of cells/segment in directions Z 	 30
  Global Number of grid segments in directions X 	 1
  Global Number of grid segments in directions Y 	 1
  Global Number of grid segments in directions Z 	 1

Summary of imported Microstructures spn file grid parameters
  Name of spn file  = xyz.spn
  Num. Cartesian grid intervals = 10  20  30
  Cartesian Grid Bounds (Min.)  = 0.000000  0.000000  0.000000
  Cartesian Grid Bounds (Max.)  = 10.000000  20.000000  30.000000
  Expanded initial Cartesian grid by 0 layers
  Number of Materials           = 4

Total Cells                = 6000
Number of Processors       = 1
Approx. Num Cells per Proc = 6000

begin SCULPT meshing...
(1/9) computing normals...
(2/9) classifying materials...
(3/9) resolving non-manifolds...
(4/9) computing dual edge intersections...
(5/9) computing material interfaces...
(6/9) generating geometry...
(7/9) generating buffer hexes...
(8/9) generating interior hexes...
(9/9) begin smoothing...
building exodus mesh...
generating global ids...
================ MESH SUMMARY ===================
Base Filename	xyz
Num Procs	1
Num Nodes	7161
Num Elements	6000
Num Blocks	4
Num Nodesets	0
Num Sidesets	0
Num Bad Qual	0
Num Poor Qual	0
Min Quality	1.000000
Avg Quality	1.000000
Min Edge Len	1.000000
Min Qual Rank	0

Job Completed Mon May 20 18:01:54 2024

Elapsed Time		0.125865 sec. (0.002098 min.)
Total Time on 1 Procs	0.125865 sec. (0.002098 min.)
Slow Rank		0
Done!
(.venv)  chovey@s1088757/Users/chovey/Downloads/spn>
```